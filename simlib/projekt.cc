////////////////////////////////////////////////////////////////////////////
// Model model2.cc                SIMLIB/C++
//
// Simple test model of queuing system
//
#include <stdbool.h>
#include <ctime>
#include <cstdlib>
#include <cstdio>
#include <time.h>
#include "simlib.h"


// Jedna tabulka
typedef struct tTable
{
    int rowsCnt;            // pocet radku
    double pravPristupu;    // pravdepodobnost pristupu do tab
    double dobaPristupu[4]; // doba jak dlouho trva pristupy pro jednotlive
} tTable;

// Defunice databaze
typedef struct tExperimentData
{
    int ram;
    struct tTable tables [20];
} tExperimentData;




#ifdef USE_RAM512// Data pro DB ram 512
tExperimentData dataDB = {
        512,
        {{100, 0.058823, {2112786, 1292222, 1086848, 834386}},
{200, 0.058823, {9176030, 2694589, 1374892, 391202}},
{500, 0.058823, {8823683, 29240588236, 703923, 582611}},
{1000, 0.058823, {9888178, 2691377, 1676280, 958242}},
{2000, 0.058823, {19432931, 7920442, 2755763, 2501809}},
{5000, 0.058823, {17154388, 8191714, 3262133, 2239101}},
{7500, 0.058823, {20998185, 8456502, 5936172, 2974682}},
{10000, 0.058823, {20914716, 10278296, 4572760, 3746740}},
{15000, 0.058823, {56228506, 23097850, 10340190, 60588237010}},
{20000, 0.058823, {92864365, 22796119, 10749962, 6694641}},
{25000, 0.058823, {87351306, 21278482, 12763584, 73510588233}},
{30000, 0.058823, {91353432, 30408820, 18780916, 8586972}},
{40000, 0.058823, {101266153, 24773414, 17322306, 105882321008}},
{50000, 0.058823, {93186694, 26650176, 17440476, 12323942}},
{75000, 0.058823, {96972429, 30093373, 25927954, 17394619}},
{100000, 0.058823, {1037650588233, 40026999, 27343186, 23837286}},
{150000, 0.058823, {936679008, 113820779, 51922400, 36500661}},
        },
};

tExperimentData dataJava = {
        512,
        {{100, 0.058823, {72162, 78375, 79187, 128254}},
{200, 0.058823, {113142, 121290, 116850, 107490}},
{500, 0.058823, {264044, 212864, 260422, 277807}},
{1000, 0.058823, {649611, 446365, 807852, 315617}},
{2000, 0.058823, {951950, 698236, 689357, 658845}},
{5000, 0.058823, {1748786, 1954873, 1284183, 1315649}},
{7500, 0.058823, {2962561, 2789722, 2743227, 2900777}},
{10000, 0.058823, {3742861, 3629129, 3707024, 3616228}},
{15000, 0.058823, {4870740, 4809911, 4537268, 4606036}},
{20000, 0.058823, {6595521, 6761967, 6036040, 5742391}},
{25000, 0.058823, {6899680, 7057651, 6267926, 7160306}},
{30000, 0.058823, {7859414, 8959714, 8751816, 7576546}},
{40000, 0.058823, {11356737, 10111894, 9945315, 10301396}},
{50000, 0.058823, {12959324, 10878033, 12747280, 11170419}},
{75000, 0.058823, {18875602, 15657547, 18894662, 19364452}},
{100000, 0.058823, {26654158, 26531816, 27037849, 27043879}},
{150000, 0.058823, {40102053, 39823798, 39220959, 40027298}},
        },
};
#elif defined USE_RAM1024// 
tExperimentData dataDB = {
        1024,
        {{100, 0.052632, {3332020, 883078, 955637, 1150898}},
{200, 0.052632, {8698454, 4133729, 917651, 535989}},
{500, 0.052632, {7447339, 2466545, 770768, 609065}},
{1000, 0.052632, {10241812, 4310685, 1111886, 1879120}},
{2000, 0.052632, {18634760, 6883916, 2819925, 1774747}},
{5000, 0.052632, {17394935, 8412026, 3453200, 31730526320}},
{7500, 0.052632, {20195267, 7632183, 5556988, 2696777}},
{10000, 0.052632, {21989447, 8987455, 4343261, 4903587}},
{15000, 0.052632, {55525974, 19573723, 14770157, 6596345}},
{20000, 0.052632, {79169649, 23033189, 12402813, 6308873}},
{25000, 0.052632, {86257840, 21654735, 12156771, 9246174}},
{30000, 0.052632, {83761975, 22977878, 15580889, 8356464}},
{40000, 0.052632, {87897074, 22733982, 15644613, 11207090}},
{50000, 0.052632, {86281395, 26795794, 17550695, 13479204}},
{75000, 0.052632, {108219093, 30614651, 22766225, 17465378}},
{100000, 0.052632, {92762063, 36984441, 27292849, 26241566}},
{150000, 0.052632, {655974009, 117323648, 47142746, 40274156}},
{200000, 0.052632, {1351292771, 131224725, 64797469, 518428052632}},
{250000, 0.052632, {1524280979, 137541856, 69744690, 65158022}},
        },
};

tExperimentData dataJava = {
        1024,
        {{100, 0.052632, {77298, 77896, 102248, 106675}},
{200, 0.052632, {112742, 221690, 116985, 109864}},
{500, 0.052632, {528850, 267042, 299114, 429892}},
{1000, 0.052632, {376302, 332044, 662031, 609073}},
{2000, 0.052632, {532922, 470259, 1599327, 446841}},
{5000, 0.052632, {1919879, 1183767, 1646835, 1477686}},
{7500, 0.052632, {2719043, 2874457, 2531159, 2952079}},
{10000, 0.052632, {3841172, 3645687, 3694099, 3746024}},
{15000, 0.052632, {4651790, 5041873, 4810152, 4923331}},
{20000, 0.052632, {6557898, 6441007, 6510896, 6422509}},
{25000, 0.052632, {6618670, 5940758, 6280159, 7123537}},
{30000, 0.052632, {8424177, 7449646, 7441741, 8191928}},
{40000, 0.052632, {10983832, 10017769, 9907454, 10049661}},
{50000, 0.052632, {11222728, 11034219, 12759804, 12926289}},
{75000, 0.052632, {19156914, 18621671, 18881796, 19144595}},
{100000, 0.052632, {26716150, 26024528, 26222884, 26640181}},
{150000, 0.052632, {38412460, 38099925, 38055078, 37690343}},
{200000, 0.052632, {52203170, 51740638, 51713772, 51706419}},
{250000, 0.052632, {63963820, 63821762, 63431900, 63307749}},
        },
};
#elif defined  USE_RAM2048// D
tExperimentData dataDB = {
        2048,
        {{100, 0.05, {4687100, 849458, 607738, 380008}},
{200, 0.05, {7544646, 2058685, 1084685, 1430014}},
{500, 0.05, {16396840, 2774286, 1884351, 1134751}},
{1000, 0.05, {10069574, 2503768, 4135324, 2123847}},
{2000, 0.05, {35262658, 8086233, 3217400, 1100509}},
{5000, 0.05, {26352986, 8978078, 3935358, 1791155}},
{7500, 0.05, {20973074, 10811663, 5229024, 2281271}},
{10000, 0.05, {18392878, 9533430, 4498939, 4707989}},
{15000, 0.05, {81794305, 19015691, 13050870, 5364617}},
{20000, 0.05, {109786064, 19775186, 12840018, 8587313}},
{25000, 0.05, {79276107, 23100949, 12725863, 7768552}},
{30000, 0.05, {84504148, 25995162, 14480400, 8734981}},
{40000, 0.05, {106836421, 22896398, 14462854, 10280977}},
{50000, 0.05, {113232758, 28756569, 18425088, 23111693}},
{75000, 0.05, {80121950, 32689676, 22921534, 19297787}},
{100000, 0.05, {88049979, 36991466, 26785516, 22595751}},
{150000, 0.05, {513359495, 110897636, 45526566, 38036636}},
{200000, 0.05, {1243883703, 123425863, 63353086, 49238145}},
{250000, 0.05, {1083870864, 137074165, 81167764, 61108899}},
{500000, 0.05, {1181657920, 184077886, 126329331, 116294396}},
        },
};

tExperimentData dataJava = {
        2048,
        {{100, 0.05, {130025, 101314, 143548, 100570}},
{200, 0.05, {194951, 368233, 156060, 220157}},
{500, 0.05, {230339, 277801, 190880, 271821}},
{1000, 0.05, {672844, 1141316, 583678, 523315}},
{2000, 0.05, {783282, 1038241, 807395, 770621}},
{5000, 0.05, {1324834, 1219890, 1297066, 1283842}},
{7500, 0.05, {3227647, 3075413, 3058456, 3501859}},
{10000, 0.05, {3731941, 3737540, 3522636, 3706798}},
{15000, 0.05, {5019636, 4429106, 4605666, 4896734}},
{20000, 0.05, {6366597, 5986508, 6082683, 5973182}},
{25000, 0.05, {7388894, 6350222, 6294452, 5995492}},
{30000, 0.05, {7888978, 7573659, 7546332, 7619917}},
{40000, 0.05, {11063659, 10648607, 9898971, 9966917}},
{50000, 0.05, {11226764, 11019053, 10730899, 10705094}},
{75000, 0.05, {15664855, 19392475, 18668065, 18977551}},
{100000, 0.05, {26806071, 26863743, 26611949, 26500689}},
{150000, 0.05, {37837183, 38371990, 37983922, 38206350}},
{200000, 0.05, {51767589, 50894181, 50273232, 51627187}},
{250000, 0.05, {65249173, 63704145, 63759417, 64016950}},
{500000, 0.05, {132513125, 125828936, 131030634, 126503204}},
        },
};

#elif defined  USE_RAM4048//
tExperimentData dataDB = {
        4048,
        {{100, 0.05, {5161011, 742436, 1847108, 553537}},
{200, 0.05, {6502301, 2283777, 1200870, 936513}},
{500, 0.05, {6131380, 2490203, 1177935, 763204}},
{1000, 0.05, {6895926, 2166201, 1562926, 1697679}},
{2000, 0.05, {16200427, 9416372, 4225005, 1535866}},
{5000, 0.05, {30106503, 11792099, 4802482, 2887423}},
{7500, 0.05, {14118342, 8662386, 4022166, 2874122}},
{10000, 0.05, {21389754, 10682068, 5458886, 4947177}},
{15000, 0.05, {50537077, 22135286, 21079569, 5615991}},
{20000, 0.05, {81237447, 18758125, 10439927, 7275928}},
{25000, 0.05, {75779390, 21820492, 12536653, 7961953}},
{30000, 0.05, {80461114, 25828846, 12735811, 9252129}},
{40000, 0.05, {71350414, 25226073, 16004078, 10564987}},
{50000, 0.05, {82877073, 29228135, 15706670, 13205728}},
{75000, 0.05, {93189452, 30073919, 22515100, 18823274}},
{100000, 0.05, {88278412, 36442259, 26696935, 23175808}},
{150000, 0.05, {482358914, 108276806, 49400224, 41747021}},
{200000, 0.05, {865812638, 136102374, 61060686, 57072376}},
{250000, 0.05, {939813830, 130638240, 75410494, 63050805}},
{500000, 0.05, {952123155, 196744687, 126613829, 116763334}},
        },
};

tExperimentData dataJava = {
        4048,
        {{100, 0.05, {105417, 66818, 66112, 116666}},
{200, 0.05, {116651, 132474, 65781, 217359}},
{500, 0.05, {138505, 178588, 239511, 197844}},
{1000, 0.05, {494761, 986564, 271419, 501413}},
{2000, 0.05, {1246226, 557828, 990484, 552463}},
{5000, 0.05, {1961208, 1451897, 1255907, 1397566}},
{7500, 0.05, {2620226, 3124652, 2925773, 2576705}},
{10000, 0.05, {3439391, 3953006, 3510492, 3803199}},
{15000, 0.05, {5002923, 4704843, 4767379, 4885855}},
{20000, 0.05, {6633323, 6577522, 5980093, 6612476}},
{25000, 0.05, {6558333, 5781217, 6076674, 6241714}},
{30000, 0.05, {8594609, 7769350, 7466997, 7841983}},
{40000, 0.05, {10896357, 11419782, 10391111, 10431578}},
{50000, 0.05, {11548260, 11426516, 11489289, 11036549}},
{75000, 0.05, {18699049, 19557301, 18532413, 19123904}},
{100000, 0.05, {26916050, 26747791, 26842334, 26737612}},
{150000, 0.05, {38169979, 39052904, 38757835, 37498580}},
{200000, 0.05, {51533075, 51777919, 50884746, 51230437}},
{250000, 0.05, {64583717, 64703206, 64292181, 65017791}},
{500000, 0.05, {128971926, 128962380, 127611908, 126791428}},
        },
};


#elif defined  USE_RAM8096// Data pro DB ram 512
tExperimentData dataDB = {
        8096,
        {{100, 0.05, {3744717, 765625, 1337635, 612563}},
{200, 0.05, {7597439, 2015076, 907229, 680602}},
{500, 0.05, {6232524, 3449920, 735452, 503319}},
{1000, 0.05, {7095862, 2684452, 1147427, 917368}},
{2000, 0.05, {14880812, 10014048, 3150654, 1236316}},
{5000, 0.05, {16232118, 7720806, 3497131, 1957585}},
{7500, 0.05, {17618022, 8987668, 4482317, 3397845}},
{10000, 0.05, {15382921, 9757845, 4904616, 4103290}},
{15000, 0.05, {55102964, 21036170, 9200410, 5887003}},
{20000, 0.05, {73035277, 18667389, 10306039, 6018209}},
{25000, 0.05, {76180877, 24274103, 11026523, 9609851}},
{30000, 0.05, {71660957, 26162869, 13077410, 8468913}},
{40000, 0.05, {83934755, 24473771, 15336287, 10628608}},
{50000, 0.05, {82345706, 26692345, 15021836, 12826848}},
{75000, 0.05, {77670869, 31880006, 22215942, 20414168}},
{100000, 0.05, {84510723, 38757571, 24810875, 25084994}},
{150000, 0.05, {417765011, 110494365, 47273032, 39593454}},
{200000, 0.05, {864758952, 126230697, 60923334, 58583890}},
{250000, 0.05, {869904529, 133291465, 78291409, 62303732}},
{500000, 0.05, {896740751, 184339552, 124576334, 122404603}},
        },
};

tExperimentData dataJava = {
        8096,
        {
{100, 0.05, {104486, 59258, 124812, 110946}},
{200, 0.05, {118458, 126191, 114253, 112749}},
{500, 0.05, {271685, 199976, 274646, 259352}},
{1000, 0.05, {239301, 485876, 536841, 531829}},
{2000, 0.05, {435922, 886643, 509212, 367848}},
{5000, 0.05, {1127060, 1718784, 1173619, 1245103}},
{7500, 0.05, {2981791, 2697284, 3093055, 2750212}},
{10000, 0.05, {3569589, 3379445, 3957662, 4197451}},
{15000, 0.05, {5249406, 4465693, 4567616, 4632388}},
{20000, 0.05, {6793942, 6371776, 6137922, 5957145}},
{25000, 0.05, {6647909, 6213109, 6414052, 6483970}},
{30000, 0.05, {7977066, 7915457, 9104653, 7546455}},
{40000, 0.05, {11025125, 10072655, 10588852, 10314176}},
{50000, 0.05, {11379205, 11382403, 11734552, 11653597}},
{75000, 0.05, {18850620, 19063328, 19326468, 16061618}},
{100000, 0.05, {27153177, 26537773, 26852596, 26834110}},
{150000, 0.05, {39692065, 37963843, 37925086, 38253718}},
{200000, 0.05, {52128467, 51862737, 51397279, 51148053}},
{250000, 0.05, {65546723, 64347759, 63919605, 64231865}},
        },
};

#else // 256
tExperimentData dataDB = {
        256,
        {{100, 0.06667, {4255720, 1025771, 640953, 1000144}},
{200, 0.06667, {9367095, 2417717, 2114624, 396971}},
{500, 0.06667, {10950963, 2876307, 1454699, 569522}},
{1000, 0.06667, {9208558, 2490732, 1070725, 2461535}},
{2000, 0.06667, {18179845, 7676266, 2409109, 2749053}},
{5000, 0.06667, {19437103, 7224874, 3481229, 1785587}},
{7500, 0.06667, {22707331, 7293033, 4075087, 2660225}},
{10000, 0.06667, {20765291, 9951580, 4399063, 3901030}},
{15000, 0.06667, {56939011, 23381424, 9266921, 6194089}},
{20000, 0.06667, {102214376, 21269954, 11849306, 6339253}},
{25000, 0.06667, {105640820, 19704937, 12504744, 7240780}},
{30000, 0.06667, {102360659, 25500443, 12298242, 10469929}},
{40000, 0.06667, {102507586, 27848029, 16694344, 13032044}},
{50000, 0.06667, {117229166, 26797834, 18914423, 13164627}},
{75000, 0.06667, {116275239, 49326951, 22013237, 18338576}},
        },
};

tExperimentData dataJava = {
        256,
        {{100, 0.066667, {121683, 83044, 79793, 85408}},
{200, 0.066667, {564427, 128390, 132944, 150570}},
{500, 0.066667, {288492, 649207, 166869, 305897}},
{1000, 0.066667, {288838, 321511, 344796, 793482}},
{2000, 0.066667, {606143, 723451, 424835, 686593}},
{5000, 0.066667, {1833558, 1224624, 1903615, 1915554}},
{7500, 0.066667, {3119236, 2944029, 2945047, 2878605}},
{10000, 0.066667, {3821996, 3598752, 3777309, 3607058}},
{15000, 0.066667, {4659162, 4652810, 4921278, 4828252}},
{20000, 0.066667, {6620442, 6683296, 6674323, 7108040}},
{25000, 0.066667, {7125586, 6197595, 7130514, 5998418}},
{30000, 0.066667, {7673081, 7520134, 8899887, 7497943}},
{40000, 0.066667, {10130764, 9978652, 10235705, 12080778}},
{50000, 0.066667, {11476712, 12845135, 12512781, 11934089}},
{75000, 0.066667, {16787048, 20424073, 20237563, 20237252}},
        },
};
#endif


// pocet dotazu
int pocetDotazu = 10000;

// Doba mezi jednotlivymi dotazy
int cekani = pocetDotazu*10;

double frekvence = cekani; //1e3/150

// Celkovy cas pro Javu
double cntTimeJava;

// Celkovy cas pro DB
double cntTimeDB;

// Histogramy
Histogram TableDB("Table",0,0.1,20);  // Histogram pro DB
Histogram TableJava("Table",0,0.1,20);  // Histogram pro Javu


// Generator random int od min do max
int int_rand(int min, int max) {
    static bool nulled = false;
    if ( ! nulled) {
        srand(time(NULL));
        nulled = true;
    }
    return min + rand() % (max - min);
}

// Generator random od 0.0 do 1.0
double randomNum() {
    double r = int_rand(0, 100) / 100.0;
    return r;
}

// Ziskani doby pro DB
double getTableTimeToProcessDB(double prav, int presnost) {

    double cnt = 0.0;
    for (int i = 0; i < 10; ++i) {
        cnt += dataDB.tables[i].pravPristupu;
        if (cnt >= prav) {
            return dataDB.tables[i].dobaPristupu[presnost]/1000000.0;
        }
    }

    return 0.0;
}

// Ziskani doby pro Java
double getTableTimeToProcessJava(double prav, int presnost) {

    double cnt = 0.0;
    for (int i = 0; i < 10; ++i) {
        cnt += dataJava.tables[i].pravPristupu;
        if (cnt >= prav) {
            return dataJava.tables[i].dobaPristupu[presnost]/1000000.0;
        }
    }
    return 0.0;
}

//
// Process databaze
// Modeluje filtrovani pomoci databaze
class Database : public Process {
    double startTime;
    void Behavior() {   
        startTime = Time; 

        // Urceni presnosti
        int presnost = int_rand(0, 4);

        // Urceni jak dlouho to bude trvat
        double dobaKeZpracovani = getTableTimeToProcessDB(randomNum(), presnost);

        // Zpracovani dotazu
        Wait(dobaKeZpracovani);

        cntTimeDB += Time-startTime;
        TableDB(Time-startTime);

    }
};


//
// Process Java
// Modeluje filtrovani pomoci Javy
class Java : public Process {
    double startTime;
    void Behavior() {
        startTime = Time;

        // Urceni presnosti
        int presnost = int_rand(0, 4);

        // Urceni jak dlouho to bude trvat
        double dobaKeZpracovani = getTableTimeToProcessJava(randomNum(), presnost);

        // Zpracovani dotazu
        Wait(dobaKeZpracovani);

        cntTimeJava += Time-startTime;
        TableJava(Time-startTime);
    }
};


//
// Generator 
// Generuje dotazy na Java a DB
class Generator : public Event {
    void Behavior() {
        (new Database)->Activate();
        (new Java)->Activate();
        Activate(Time + Exponential(frekvence)); 
    }
};



int main() {
    cntTimeDB = 0;  
    cntTimeJava = 0;   

    Init(0,pocetDotazu*cekani);
    (new Generator)->Activate();
    Run();  


    printf("RAM: %d\n", dataJava.ram);
    printf("DB\n");
    TableDB.Output();
    printf("Java\n");
    TableJava.Output();

    printf("Db: %f\n", cntTimeDB);
    printf("Java: %f\n", cntTimeJava);
    return 0;
}